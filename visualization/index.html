<!DOCTYPE html>
<html lang="en">
<head>
	<title>uulm-networking</title>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<script src="./js/libs/jquery-1.8.3.js"></script>
	<script src="./js/libs/jquery-ui.js"></script>
	<link rel="stylesheet" href="./css/jquery-ui.css" />

	<script type="text/javascript" src="./js/dat.gui.min.js"></script>
	<script type="text/javascript" src="./aps.js"></script>

	<link rel="stylesheet" href="./css/style.css">	
</head>
<body>
	<script src="js/three.min.js"></script>
	<script src="js/threejs/Detector.js"></script>
	<script src="js/threejs/controls/TrackballControls.js"></script>
	<script src="js/threejs/THREEx.KeyboardState.js"></script>
	<script src="js/threejs/THREEx.FullScreen.js"></script>
	<script src="js/threejs/THREEx.WindowResize.js"></script>

	<script src="js/BasicShader.js"></script>
	<script src="./one-week.js"></script>


	<script>
	if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

	var SCREEN_WIDTH = window.innerWidth;
	var SCREEN_HEIGHT = window.innerHeight;

	var container;
	var camera, scene, renderer, controls;

	var mouseX = 0, mouseY = 0;

	var windowHalfX = window.innerWidth / 2;
	var windowHalfY = window.innerHeight / 2;

	init();
	animate();


	function init() {
		container = document.createElement( 'div' );
		document.body.appendChild( container );
		scene = new THREE.Scene();

		var VIEW_ANGLE = 35, 
			ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, 
			NEAR = 1, FAR = 5000;
		camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);

		camera.position.set(400, -1307, 2352)
		camera.up.set(-0.858, 1.62, 1.32)
		camera.rotation.set(0.5, 0.304, 0.424)
		/*
		camera.position.set(400, -1591, 2295)
		camera.up.set(-0.87, 1.58, 1.37)
		camera.rotation.set(0.6, 0.27, 0.409)
		*/

		//camera.position.set(300, -2018.431842068944 , 2065.8693155315623)
		//camera.rotation.set(0.8209928117598853, 0.5235031107736153 , 0.3368911033861802)
		//camera.up.set(-0.8644827301596901, 1.4506415456797592, 1.5201673313170037)
		scene.add(camera);


		THREEx.WindowResize(renderer, camera);
		THREEx.FullScreen.bindKey({ charCode : 'm'.charCodeAt(0) });

		var light = new THREE.PointLight(0xffffff);
		light.position.set(0,0,1800);
		scene.add(light);

		var directionalLight = new THREE.DirectionalLight(0xffffff);
		directionalLight.position.set(1, 1, 1).normalize();
		scene.add(directionalLight);

		var material = new THREE.MeshBasicMaterial({
			map: THREE.ImageUtils.loadTexture("map-simple.svg")
		});

		var geometry = new THREE.PlaneGeometry(3074, 1782);
		var meshCanvas = new THREE.Mesh(geometry, material);
		//meshCanvas.rotation.x = - Math.PI / 3;
		scene.add(meshCanvas);

		var sphereMaterial = new THREE.MeshLambertMaterial({color: 0xFF0000,
		 transparent: true,
		blending: THREE.AdditiveBlending});

		var material = new THREE.ParticleBasicMaterial(
			{map: new THREE.Texture( generateSprite() ), blending: THREE.AdditiveBlending});
		//particle = new THREE.Particle( material );

		particle = new THREE.Particle( sphereMaterial );
		particle.position.x = 600;
		particle.position.y = 600;
		particle.position.z = 0;
		particle.scale.x = particle.scale.y = 100

		scene.add(particle);


var shader = THREE.BasicShader;
var uniforms = THREE.UniformsUtils.clone( shader.uniforms );

			//uniforms[ "tCube" ].value = textureCube;

var parameters = {fragmentShader: shader.fragmentShader, vertexShader: shader.vertexShader,
		 transparent: true, 
		 uniforms: uniforms, 
		 blending: THREE.AdditiveBlending};
		 //blending: THREE.NormalBlending};

//var material = new THREE.MeshLambertMaterial( parameters);
var material = new THREE.ShaderMaterial( parameters);



		for (var i in aps.rows) {
			var id = aps.rows[i].id;
			var value = aps.rows[i].value;

			if (value.length == 0) continue;

			//console.log(id + " " + oneWeek[id])

			var h = oneWeek[id] * 0.0004;
		       	var sphere = new THREE.Mesh(new THREE.SphereGeometry(20*h, 40, 40), material);
		       sphere.overdraw = true;
			var pos = coord2px(value[0][0], value[0][1]);
			sphere.position.x = pos.x;
			sphere.position.y = pos.y;
			scene.add(sphere);
		//break;
		}

               var sphere = new THREE.Mesh(new THREE.SphereGeometry(60, 50, 50), material);
	       sphere.overdraw = true;
               //var sphere = new THREE.Mesh(new THREE.SphereGeometry(30, 16, 16), shaderMaterial);
               //var sphere = new THREE.Mesh(new THREE.Sphere(30, 16, 16), shaderMaterial);
               //var sphere = new THREE.Mesh(new THREE.SphereGeometry( 30, 30, 40), sphereMaterial);
			       var pos = coord2px(48.42484, 9.95309);
                               sphere.position.x = pos.x;
                               sphere.position.y = pos.y;
		sphere.scale.x +=1;
		sphere.scale.y +=1;
		sphere.scale.z +=1;
	       sphere.position.y += 50;
	       //scene.add(sphere);


		renderer = new THREE.WebGLRenderer({ antialias: true});
		renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
		renderer.setClearColor("#000", 1);

		container.appendChild(renderer.domElement);
		document.addEventListener('mousemove', onDocumentMouseMove, false);

		controls = new THREE.TrackballControls(camera, renderer.domElement);
	}


	function generateSprite() {
		var canvas = document.createElement( 'canvas' );
		canvas.width = 16;
		canvas.height = 16;

		var context = canvas.getContext( '2d' );
		var gradient = context.createRadialGradient( canvas.width / 2, canvas.height / 2, 0, canvas.width / 2, canvas.height / 2, canvas.width / 2 );
		gradient.addColorStop( 0, 'rgba(255,255,255,1)' );
		gradient.addColorStop( 0.2, 'rgba(0,255,255,1)' );
		gradient.addColorStop( 0.4, 'rgba(0,0,64,1)' );
		gradient.addColorStop( 1, 'rgba(0,0,0,1)' );

		context.fillStyle = gradient;
		context.fillRect( 0, 0, canvas.width, canvas.height );

		return canvas;
	}


	function onDocumentMouseMove(event) {
		mouseY = event.clientY;
		//mouseX = (event.clientX - windowHalfX);
		//mouseY = (event.clientY - windowHalfY);
	}


	function animate() {
		requestAnimationFrame(animate);
		render();
	}


	function render() {
		//camera.position.x += 10;

		renderer.clear();
		renderer.render(scene, camera);
		controls.update();
		/*
		console.log(
			" " + camera.position.x +
			" " + camera.position.y +
			" " + camera.position.z
		);
		*/
	}

	function coord2px(lat, lon) {
		/*
			48.42677
		9.94224		 9.96477
			48.41809
		*/
		var bbLeft = 9.94224;
		var bbRight = 9.96477;
		var bbTop = 48.42677;
		var bbBottom = 48.41809;

		var bbHeight = bbTop - bbBottom;
		var bbWidth = bbRight - bbLeft;

		var imgWidth = 3074;
		var imgHeight = 1782;

		var shiftX = -1537;
		var shiftY = -891;

		//var lat = 48.42231;
		//var lon = 9.95425;


		var coordX = ((imgWidth / bbWidth) * (lon - bbLeft)) + shiftX;
		var coordY = ((imgHeight / bbHeight) * (bbTop - lat)) + shiftY;
		coordY *= -1;

		return {x: coordX, y: coordY};
	}

    
	var FizzyText = function() {
	  this.time = 12;
	  this["display entire week"] = false;
	  this.weekday = "Monday";
	};

	window.onload = function() {
	  var text = new FizzyText();
	  var gui = new dat.GUI({ autoPlace: false, width: 295 });
	  document.getElementById("gui").appendChild(gui.domElement);
	  /*
	  $("#gui").mousemove(function(event) {
		  event.stopPropagation();
	});
	*/

	  gui.add(text, 'weekday', ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] );
	  gui.add(text, 'time', 0, 24);
	  gui.add(text, 'display entire week');
	};
	</script>

	<a href="https://github.com/cmichi/uulm-network-visualization">
	     <img style="position: absolute; top: 0; right: 0; border: 0; z-index:9999; opacity:0.7;" 
	     src="./img/forkme_right_gray_6d6d6d.png" 
	     alt="Fork me on GitHub">
	 </a>

	<img src="./img/uulm.png" alt="" class="uulmlogo" />

	<div class="logos">
		<a href="javascript:dialog()"><img width="45" src="./img/logos-large/ulmapi.png" alt="ulmapi"
			title="Informationen zu diesem Projekt" /></a>
	</div>

	<div id="dialog" title="uulm Network Visualization">
		<h4 style='margin-bottom:8px'>&Uuml;ber dieses Projekt</h4>

		<div style='float:right;margin-left:10px;'>
			<a href="http://ulmAPI.de/" tabindex="-1"
			   title="Hochschulgruppe 'datalove' f&uuml;r offene Daten an der Uni Ulm">
				<img src="./img/logos-large/ulmapi.png" 
					width='100' 
					alt="ulmAPI.de"
					title="Hochschulgruppe f&uuml;r offene Daten an der Uni Ulm" />
			</a>
		</div>

		<p>
			Weitere Projekte und Infos rund um unsere Hochschulgruppe "datalove"
			finden sich hier: <a href="http://ulmAPI.de/">http://ulmAPI.de</a>.
		</p>
	</div>

	<div class="description">
		Visualizing Access Point authentications
		within the University of Ulm.
		Data under ODbL v1.0. 
		<!-- Visualization: Michael MÃ¼ller. -->
	</div>

	<div id="gui"></div>

</body>
</html>
